# –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ


- [–í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å](#dforget)
- [–î–æ—Å—Ç—É–ø K8s Api —Å–Ω–∞—Ä—É–∂–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)](#df)
- [–î–æ—Å—Ç—É–ø K8s Api –∏–∑–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)](#d)

## üßê –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å <a name = "dforget"></a>

–í—Å—ë –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å K8s —Å–≤–æ–¥–∏—Ç—Å—è –∫ –∑–∞–ø—Ä–æ—Å–∞–º –Ω–∞ API. –≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (`kubectl`) —Ç–∞–∫ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏.
K8s Api –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ç–µ–º –∏–ª–∏ –∏–Ω—ã–º —Ä–µ—Å—É—Ä—Å–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞** –≤ –ø–æ–ª—è—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã `CN=<–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å> O=<–≥—Ä—É–ø–ø–∞>/`. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä–Ω–µ–≤—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º K8s
- **JWT —Ç–æ–∫–µ–Ω–∞** –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–ø–∏—Å–∞–Ω –∫–æ—Ä–Ω–µ–≤—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º –∫–ª–∞—Å—Ç–µ—Ä–∞, –≤ –Ω—ë–º —Ç–∞–∫-–∂–µ —É–∫–∞–∑–∞–Ω –Ω–∞–∑–≤–∞–Ω–∏–µ `service account` (–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –∏ `namespace` –≥–¥–µ –ª–µ–∂–∏—Ç —ç—Ç–æ—Ç `sa`


**Service Account** 
- –ü—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ë—ã–ª —Å–æ–∑–¥–∞–Ω –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∞–≤. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å K8s –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —Ç–æ–∫–µ–Ω–æ–≤ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ `service account`. –î–µ–ª–æ –≤ —Ç–æ–º, —á—Ç–æ Kubernetes –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤ —Ç–æ–º –≤–∏–¥–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –º—ã –ø—Ä–∏–≤—ã–∫–ª–∏ –∏—Ö –≤–∏–¥–µ—Ç—å –≤ –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞, –≥–¥–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å, –≥—Ä—É–ø–ø—ã –∏ —Ç.–¥. –¢–æ –µ—Å—Ç—å –≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ Kubernetes –Ω–∏–∫–∞–∫–∏—Ö —Å–ø–∏—Å–∫–æ–≤ –ª–æ–≥–∏–Ω–æ–≤, –≥—Ä—É–ø–ø –∏ –ø–∞—Ä–æ–ª–µ–π –Ω–µ —Ö—Ä–∞–Ω–∏—Ç.

**–†–æ–ª–∏**
- `Role` 

  –≠—Ç–æ YAML-–º–∞–Ω–∏—Ñ–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–µ–∫–∏–π –Ω–∞–±–æ—Ä –ø—Ä–∞–≤ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã –∫–ª–∞—Å—Ç–µ—Ä–∞. Role –Ω–∏—á–µ–≥–æ –∏ –Ω–∏–∫–æ–º—É –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç. –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫.
  –û–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –≤ ns, —Å—É—â–Ω–æ—Å—Ç—å Role –Ω–µ–π–º—Å–ø–µ–π—Å-–∑–∞–≤–∏—Å–∏–º–∞—è, –∏ –º—ã –º–æ–∂–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–æ–ª–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º –≤ —Ä–∞–∑–Ω—ã—Ö –Ω–µ–π–º—Å–ø–µ–π—Å–∞—Ö.
  –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º —Ä–æ–ª–∏ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –¥—Ä—É–≥–æ–π —Ä–µ—Å—É—Ä—Å,  `RoleBinding` 

- `ClusterRole`

  –≠—Ç–æ –∫–ª–∞—Å—Ç–µ—Ä–Ω—ã–π –æ–±—ä–µ–∫—Ç, —ç—Ç–∞ —Å—É—â–Ω–æ—Å—Ç—å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã –≤–æ –≤—Å—ë–º –∫–ª–∞—Å—Ç–µ—Ä–µ.

**–ë–∏–Ω–¥–∏–Ω–≥–∏**

- `RoleBinding`

  –ù–∞–∑–Ω–∞—á–∞–µ—Ç —Ä–æ–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º sa –≤ —Ä–∞–º–∫–∞—Ö ns —Ç.–µ. –¥–∞—ë—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Ç–µ–º —Å—É—â–Ω–æ—Å—Ç—è–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ç–æ–º –∂–µ ns

- `ClusterRoleBinding`

  –ù–∞–∑–Ω–∞—á–∞–µ—Ç —Ä–æ–ª—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º sa –≤–æ –≤—Å–µ—Ö –Ω–µ–π–º—Å–ø–µ—Å–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å—Ä–∞–∑—É.



## üßê –î–æ—Å—Ç—É–ø K8s Api —Å–Ω–∞—Ä—É–∂–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å) <a name = "df"></a>

–î–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É —Å–Ω–∞—Ä—É–∂–∏ –æ–±—ã—á–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–π–ª–∞ `~/.kube/kubeconfig`  –≤ –∫–æ—Ç–æ—Ä–æ–º —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
- –ø–µ—Ä–µ—á–µ–Ω—å –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- –ø–µ—Ä–µ—á–µ–Ω—å –∞–∫–∫—É–Ω—Ç–æ–≤ (—Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ –∏–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤)
- –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∞–∫–∫–∞—É–Ω—Ç–æ–º. –ó–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ –∏–ª–∏ –∏–Ω–æ–π –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ `RBAC`, –∫–æ—Ç–æ—Ä—ã–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∞–∫–∫–∞—É–Ω—Ç –∏ –∞–≤—Ç–æ—Ä–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–≤—è–∑–∞–Ω–∞ —Å —ç—Ç–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º. 
–ï—Å–ª–∏ –≤ —Ä–æ–ª–∏ —É–∫–∞–∑–∞–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–æ —Ç–æ–≥–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ–π.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ API –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –∫–ª—é—á–∞** –∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `~/.kube/kubeconfig` (—Ç–∞–∫-–∂–µ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Å—Ç–æ –ø—É—Ç–∏ –¥–æ –Ω–∏—Ö) 
- **–ö–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ç–æ–∫–µ–Ω–∞**, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞ —Å —Ç–∏–ø–æ–º `kubernetes.io/service-account-token`. –¢–∞–∫–æ–π —Ç–∏–ø –°–µ–∫—Ä–µ—Ç–æ–≤ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –∏–º—è –æ–ø–µ—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ `service account`. –≠—Ç–æ—Ç `service account` –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∏–Ω–¥–∏—Ç—Å—è —Å –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ä–æ–ª—å—é. –î–∞–ª–µ–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ —Ñ–∞–π–ª–µ `~/.kube/kubeconfig`

–í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–ª–∞—Å—Ç–µ—Ä–Ω—É—é —Ä–æ–ª—å edit –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º –µ—ë —é–∑–µ—Ä–∞–º, —Ç–µ–º —Å–∞–º—ã–º —Ä–∞–∑–¥–∞—ë–º –∏–º –¥–æ—Å—Ç—É–ø—ã –≤ –Ω—É–∂–Ω—ã–µ –Ω–µ–π–º—Å–ø–µ–π—Å—ã. –î–æ—Å—Ç–∏–≥–∞–µ–º –º—ã —ç—Ç–æ–≥–æ –ø—É—Ç—ë–º –ø—Ä–∏–≤—è–∑–∫–∏ ClusterRole –∫ RoleBinding –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ 


```
apiVersion: v1
kind: ServiceAccount
metadata:
  name: user-app
  namespace: app

---
apiVersion: v1
kind: Secret
metadata:
  name: usr-app-token
  namespace: app
  annotations:
    kubernetes.io/service-account.name: user-app
type: kubernetes.io/service-account-token

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: user-app-rb
subjects:
- kind: ServiceAccount
  name: user-app
  namespace: app
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: edit
```




## üßê –î–æ—Å—Ç—É–ø K8s Api –∏–∑–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è) <a name = "d"></a>

> Secret —Å —ç—Ç–∏–º —Ç–æ–∫–µ–Ω–æ–º –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –≥–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∏ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–Ω–∞–µ—Ç –∏ —É–º–µ–µ—Ç –≤ Kubernetes, –æ–Ω–æ –±–µ—Ä—ë—Ç —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞ `/var/run/secrets/kubernetes.io/serviceaccount/token`, —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑ secret, –∏ —Å –Ω–∏–º –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –≤ API K8s. 



## –°–æ–∑–¥–∞–Ω–∏–µ kubeconfig
```
SERVICE_ACCOUNT_NAME=cd
SECRET_NAME=${SERVICE_ACCOUNT_NAME}-token
CONTEXT=$(kubectl config current-context)
NAMESPACE=users

NEW_CONTEXT=${SERVICE_ACCOUNT_NAME}-context
KUBECONFIG_FILE="kubeconfig-${SERVICE_ACCOUNT_NAME}"

TOKEN=`kubectl -n ${NAMESPACE} get secret ${SECRET_NAME} -o jsonpath='{.data.token}' | base64 --decode`

kubectl config view --raw > ${KUBECONFIG_FILE}.full.tmp
kubectl --kubeconfig ${KUBECONFIG_FILE}.full.tmp config use-context ${CONTEXT}
kubectl --kubeconfig ${KUBECONFIG_FILE}.full.tmp config view --flatten --minify > ${KUBECONFIG_FILE}.tmp
kubectl config --kubeconfig ${KUBECONFIG_FILE}.tmp rename-context ${CONTEXT} ${NEW_CONTEXT}
kubectl config --kubeconfig ${KUBECONFIG_FILE}.tmp set-credentials ${SERVICE_ACCOUNT_NAME} --token ${TOKEN}
kubectl config --kubeconfig ${KUBECONFIG_FILE}.tmp set-context ${NEW_CONTEXT} --user ${SERVICE_ACCOUNT_NAME}
kubectl config --kubeconfig ${KUBECONFIG_FILE}.tmp view --flatten --minify > ${KUBECONFIG_FILE}
rm ${KUBECONFIG_FILE}.full.tmp
rm ${KUBECONFIG_FILE}.tmp
```